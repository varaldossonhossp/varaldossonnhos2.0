/* ============================================================
   ğŸ’™ VARAL DOS SONHOS â€” API / Pontos de Coleta
   ------------------------------------------------------------
   CRUD completo para administraÃ§Ã£o dos pontos de coleta.
   IntegraÃ§Ã£o direta com Airtable, compatÃ­vel com Vercel.

   Tabela: "pontos_coleta" â€” Campos utilizados:

   ğŸ”¹ nome_ponto          (Single line text)
       Nome pÃºblico do ponto de coleta.

   ğŸ”¹ cep                 (Single line text)
       Armazenado como texto. Formato com mÃ¡scara: 00000-000.
       Usado para busca automÃ¡tica de endereÃ§o via ViaCEP (front).

   ğŸ”¹ numero              (Single line text)
       NÃºmero do endereÃ§o â€” separado da rua.

   ğŸ”¹ endereco            (Single line text)
       Ex: â€œRua X, Bairro Y, Cidade - UFâ€.
       Preenchido automaticamente via CEP + manual.

   ğŸ”¹ telefone            (Phone number)
       MÃ¡scara no front-end: (11) 99999-9999.

   ğŸ”¹ email_ponto         (Email)
       Email direto do responsÃ¡vel pelo ponto.

   ğŸ”¹ horario             (Single line text)
       Ex: â€œSeg a Sex, 8h Ã s 18hâ€.

   ğŸ”¹ responsavel         (Single line text)
       Pessoa responsÃ¡vel pelo ponto.

   ğŸ”¹ status              (Single select)
       Valores aceitos:
         - ativo
         - inativo

   ğŸ”¹ data_cadastro       (Date â€” ISO)
       Preenchido automaticamente na criaÃ§Ã£o:
       formato: YYYY-MM-DD

   ------------------------------------------------------------
   Endpoints disponÃ­veis:
   ------------------------------------------------------------
   â€¢ GET    â†’ Lista todos os pontos
   â€¢ POST   â†’ Cria novo ponto
   â€¢ PATCH  â†’ Edita um ponto existente
   â€¢ DELETE â†’ Remove um ponto

   ğŸ”§ FunÃ§Ã£o fetchComRetry()
   Garante maior estabilidade em chamadas ao Airtable,
   realizando vÃ¡rias tentativas automÃ¡ticas em caso de falhas temporÃ¡rias.

   ------------------------------------------------------------
   IMPORTANTE:
   - NÃ£o alterar nomes dos campos sem ajustar tambÃ©m no Airtable.
   - Esta API Ã© utilizada em outras pÃ¡ginas; NÃƒO modificar mÃ©todos.
   ============================================================ */

import Airtable from "airtable";

export const config = { runtime: "nodejs" };

// ============================================================
// ğŸ” FunÃ§Ã£o auxiliar â€” Tentativa automÃ¡tica com retries
// ============================================================
async function fetchComRetry(acao, tentativas = 3, delayMs = 1000) {
  for (let i = 0; i < tentativas; i++) {
    try {
      return await acao();
    } catch (erro) {
      console.warn(`âš ï¸ Tentativa ${i + 1} falhou: ${erro.message}`);
      if (i === tentativas - 1) throw erro;
      await new Promise((r) => setTimeout(r, delayMs));
    }
  }
}

export default async function handler(req, res) {
  const base = new Airtable({ apiKey: process.env.AIRTABLE_API_KEY })
    .base(process.env.AIRTABLE_BASE_ID);

  const tabela = base(process.env.AIRTABLE_PONTOS_TABLE || "pontos_coleta");

  try {
    // ============================================================
    // ğŸ“Œ GET â€” Listar todos os pontos
    // ============================================================
    if (req.method === "GET") {
      const registros = await fetchComRetry(() =>
        tabela
          .select({
            maxRecords: 100,
            sort: [{ field: "nome_ponto", direction: "asc" }],
          })
          .all()
      );

      const pontos = registros.map((r) => ({
        id_ponto: r.id,
        nome_ponto: r.get("nome_ponto"),
        cep: r.get("cep"),
        numero: r.get("numero"),
        endereco: r.get("endereco"),
        telefone: r.get("telefone"),
        email_ponto: r.get("email_ponto"),
        horario: r.get("horario"),
        responsavel: r.get("responsavel"),
        status: r.get("status"),
        data_cadastro: r.get("data_cadastro"),
      }));

      return res.status(200).json({ sucesso: true, pontos });
    }

    // ============================================================
    // ğŸ“Œ POST â€” Criar novo ponto
    // ============================================================
    else if (req.method === "POST") {
      const dados = {
        nome_ponto: req.body.nome_ponto,
        cep: req.body.cep,
        numero: req.body.numero,
        endereco: req.body.endereco,
        telefone: req.body.telefone,
        email_ponto: req.body.email_ponto,
        horario: req.body.horario,
        responsavel: req.body.responsavel,
        status: req.body.status || "ativo",
        data_cadastro: new Date().toISOString().split("T")[0], // formato ISO
      };

      const novo = await tabela.create([{ fields: dados }]);

      return res
        .status(201)
        .json({ sucesso: true, ponto: { id_ponto: novo[0].id, ...dados } });
    }

    // ============================================================
    // ğŸ“Œ PATCH â€” Editar ponto existente
    // ============================================================
    else if (req.method === "PATCH") {
      const { id_ponto, ...fields } = req.body;

      if (!id_ponto)
        return res
          .status(400)
          .json({ sucesso: false, mensagem: "ID do ponto Ã© obrigatÃ³rio" });

      const atualizado = await tabela.update([{ id: id_ponto, fields }]);

      return res
        .status(200)
        .json({ sucesso: true, ponto: { id_ponto, ...fields } });
    }

    // ============================================================
    // ğŸ“Œ DELETE â€” Apagar ponto de coleta
    // ============================================================
    else if (req.method === "DELETE") {
      const { id_ponto } = req.body;

      if (!id_ponto)
        return res
          .status(400)
          .json({ sucesso: false, mensagem: "ID do ponto Ã© obrigatÃ³rio" });

      await tabela.destroy([id_ponto]);

      return res
        .status(200)
        .json({ sucesso: true, mensagem: "Ponto excluÃ­do com sucesso." });
    }

    // ============================================================
    // âŒ MÃ©todo nÃ£o suportado
    // ============================================================
    else {
      res.setHeader("Allow", ["GET", "POST", "PATCH", "DELETE"]);
      return res.status(405).end(`MÃ©todo ${req.method} nÃ£o permitido.`);
    }
  } catch (erro) {
    console.error("Erro API pontos_coleta:", erro);
    return res.status(500).json({ sucesso: false, mensagem: erro.message });
  }
}
