<!-- // ============================================================
 // üíå VARAL DOS SONHOS ‚Äî /pages/relatorio-cartinhas.html
 // ------------------------------------------------------------
 // P√°gina de relat√≥rio de cartinhas no painel administrativo:
 // ‚Ä¢ Filtros din√¢micos para status, evento, escola, idade, sexo e irm√£os
 // ‚Ä¢ Tabela detalhada das cartinhas com informa√ß√µes essenciais
 // ‚Ä¢ Bot√£o para gerar PDF do relat√≥rio filtrado
 // ============================================================ --> 

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üíå Relat√≥rio de Cartinhas | Varal dos Sonhos</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../imagens/favicon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: "Poppins", sans-serif; background: #f2f7fc; }
    table th {
      background: #e0ebff;
      color: #003366;
      text-align: left;
      padding: 8px;
    }
    table td {
      padding: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
    .btn {
      background-color: #2563eb;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: 0.2s;
    }
    .btn:hover { background-color: #1d4ed8; }

    @media print {
      body {
        background: white !important;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      #filtros, .voltar { display: none !important; }
      main {
        box-shadow: none !important;
        border: none !important;
        margin: 0 auto;
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center py-8 px-4">
  <main id="relatorio" class="bg-white shadow-md rounded-xl p-8 max-w-6xl w-full border border-blue-100">

    <!-- üîπ Cabe√ßalho -->
    <header class="flex justify-between items-center mb-6 border-b pb-3">
      <div class="flex items-center gap-3">
        <img src="../imagens/logo.png" alt="Logo Varal" class="w-14 h-14 object-contain" />
        <div>
          <h1 class="text-xl font-bold text-blue-800">Varal dos Sonhos üíô</h1>
          <p class="text-sm text-gray-600">Relat√≥rio de Cartinhas</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-600">
        <p><strong>Data:</strong> <span id="dataAtual"></span></p>
        <p><strong>Total:</strong> <span id="totalCartinhas">0</span></p>
      </div>
    </header>

    <!-- üîπ Filtros -->
    <div id="filtros" class="flex flex-wrap items-center gap-4 mb-6">

      <!-- Status -->
      <div>
        <label class="font-medium text-blue-800">Status da Cartinha:</label>
        <select id="filtroStatus" class="p-2 border rounded-md">
          <option value="todos">Todos</option>
          <option value="disponivel">Dispon√≠vel</option>
          <option value="adotada">Adotada</option>
          <option value="inativa">Inativa</option>
        </select>
      </div>

      <!-- Evento -->
      <div>
        <label class="font-medium text-blue-800">Evento:</label>
        <select id="filtroEvento" class="p-2 border rounded-md">
          <option value="todos">Todos</option>
        </select>
      </div>

      <!-- Escola -->
      <div>
        <label class="font-medium text-blue-800">Escola:</label>
        <select id="filtroEscola" class="p-2 border rounded-md">
          <option value="todos">Todas</option>
        </select>
      </div>

      <!-- Idade -->
      <div>
        <label class="font-medium text-blue-800">Idade:</label>
        <select id="filtroIdade" class="p-2 border rounded-md">
          <option value="todos">Todas</option>
          <option value="0-5">0 a 5</option>
          <option value="6-10">6 a 10</option>
          <option value="11-15">11 a 15</option>
          <option value="16-18">16 a 18</option>
        </select>
      </div>

      <!-- Sexo -->
      <div>
        <label class="font-medium text-blue-800">Sexo:</label>
        <select id="filtroSexo" class="p-2 border rounded-md">
          <option value="todos">Todos</option>
          <option value="menino">Menino</option>
          <option value="menina">Menina</option>
          <option value="outro">Outro</option>
        </select>
      </div>

      <!-- Irm√£os -->
      <div>
        <label class="font-medium text-blue-800">Irm√£os:</label>
        <select id="filtroIrmaos" class="p-2 border rounded-md">
          <option value="todos">Todos</option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>

      <!-- Bot√µes -->
      <button id="btnFiltrar" class="btn">üîç Filtrar</button>
      <button id="btnPDF" class="btn bg-green-600 hover:bg-green-700">üñ®Ô∏è Gerar Relat√≥rio</button>

      <a href="admin.html" class="ml-auto text-blue-600 hover:underline voltar">‚¨ÖÔ∏è Voltar ao Painel</a>
    </div>

    <!-- üîπ Tabela -->
    <section>
      <h2 class="text-lg font-semibold text-blue-800 mb-4 border-b pb-2">üíå Cartinhas Cadastradas</h2>
      <div class="overflow-x-auto">
        <table id="tabelaCartinhas" class="w-full border-collapse text-sm md:text-base">
          <thead>
            <tr>
              <th>#</th>
              <th>Crian√ßa</th>
              <th>Idade</th>
              <th>Sexo</th>
              <th>Sonho</th>
              <th>Escola</th>
              <th>Cidade</th>
              <th>Irm√£os</th>
              <th>Evento</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <tr><td colspan="10" class="text-center text-gray-400 py-4">Carregando cartinhas...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- ==================== JS ==================== -->
<script src="../js/config-site-apply.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  carregarData();
  carregarCartinhas();
  document.getElementById("btnFiltrar").addEventListener("click", filtrar);
  document.getElementById("btnPDF").addEventListener("click", () => window.print());
});

// Data
function carregarData() {
  document.getElementById("dataAtual").textContent =
    new Date().toLocaleDateString("pt-BR");
}

let cartinhasOriginais = [];

// CARREGAR CARTINHAS
async function carregarCartinhas() {
  const tbody = document.getElementById("tabelaBody");

  try {
    const resp = await fetch("/api/cartinha");
    const json = await resp.json();

    if (!json.sucesso) {
      tbody.innerHTML = `<tr><td colspan="10" class="text-center text-red-500">Erro ao carregar dados</td></tr>`;
      return;
    }

    cartinhasOriginais = json.cartinha;

    preencherFiltros();
    preencherTabela(cartinhasOriginais);

  } catch (err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-red-500">Erro inesperado</td></tr>`;
  }
}

// Preenche filtros din√¢micos
function preencherFiltros() {
  const selEvento = document.getElementById("filtroEvento");
  const selEscola = document.getElementById("filtroEscola");

  const eventos = new Set();
  const escolas = new Set();

  cartinhasOriginais.forEach(c => {
    if (c.evento_nome) eventos.add(c.evento_nome);
    if (c.escola) escolas.add(c.escola);
  });

  eventos.forEach(ev => {
    selEvento.innerHTML += `<option value="${ev}">${ev}</option>`;
  });

  escolas.forEach(es => {
    selEscola.innerHTML += `<option value="${es}">${es}</option>`;
  });
}

// Preencher tabela
function preencherTabela(lista) {
  const tbody = document.getElementById("tabelaBody");
  tbody.innerHTML = "";

  if (!lista.length) {
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-gray-500 py-4">Nenhuma cartinha encontrada</td></tr>`;
    return;
  }

  lista.forEach((f, index) => {
    tbody.innerHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${f.nome_crianca || "-"}</td>
        <td>${f.idade || "-"}</td>
        <td>${f.sexo || "-"}</td>
        <td>${f.sonho || "-"}</td>
        <td>${f.escola || "-"}</td>
        <td>${f.cidade || "-"}</td>
        <td>${f.irmaos ?? "-"}</td>
        <td>${f.evento_nome || "-"}</td>
        <td>${f.status || "-"}</td>
      </tr>
    `;
  });

  document.getElementById("totalCartinhas").textContent = lista.length;
}

// FILTRAR
function filtrar() {
  const status = document.getElementById("filtroStatus").value;
  const evento = document.getElementById("filtroEvento").value;
  const escola = document.getElementById("filtroEscola").value;
  const idadeFaixa = document.getElementById("filtroIdade").value;
  const sexo = document.getElementById("filtroSexo").value;
  const irmaosFiltro = document.getElementById("filtroIrmaos").value;

  const filtradas = cartinhasOriginais.filter(f => {

    let idadeOk = true;
    if (idadeFaixa !== "todos") {
      const [min, max] = idadeFaixa.split("-").map(Number);
      idadeOk = f.idade >= min && f.idade <= max;
    }

    const irmaosOk =
      irmaosFiltro === "todos" ||
      (irmaosFiltro === "sim" && f.irmaos > 0) ||
      (irmaosFiltro === "nao" && f.irmaos == 0);

    return (
      (status === "todos" || f.status === status) &&
      (evento === "todos" || f.evento_nome === evento) &&
      (escola === "todos" || f.escola === escola) &&
      idadeOk &&
      (sexo === "todos" || f.sexo === sexo) &&
      irmaosOk
    );
  });

  preencherTabela(filtradas);
}
</script>

</body>
</html>
